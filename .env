YNAB_EMAIL=rancangbangun123d@gmail.com
YNAB_PASSWORD=Aku@1234567890
PORT=3000

log("üîç Opening left sidebar budget menu...");

// 1Ô∏è‚É£ WAIT FOR THE BUTTON
await page.waitForSelector("button.sidebar-nav-menu-budget", {
  visible: true,
  timeout: 15000,
});

// 2Ô∏è‚É£ CLICK THE BUTTON
const btn = await page.$("button.sidebar-nav-menu-budget");
await btn.click();
await page.waitForTimeout(500);

// 3Ô∏è‚É£ VERIFY IT ACTUALLY OPENED
let submenuVisible = await page.$("button.modal-select-budget-open");

if (!submenuVisible) {
  log("‚ö†Ô∏è Sidebar didn‚Äôt open ‚Äî retrying with mouse move + click");
  
  // Move mouse onto the menu button (YNAB sometimes requires hover before click)
  const box = await btn.boundingBox();
  await page.mouse.move(box.x + box.width / 2, box.y + box.height / 2);
  await page.waitForTimeout(200);

  await btn.click();
  await page.waitForTimeout(800);

  submenuVisible = await page.$("button.modal-select-budget-open");
}

if (!submenuVisible) {
  throw new Error("‚ùå Sidebar menu FAILED to open. Selector might be wrong or app not ready.");
}

log("üìÇ Left sidebar menu OPENED.");

console.log(`üîç Selecting budget: "${budgetName}" ...`);

await page.waitForTimeout(1000);

// 1Ô∏è‚É£ Locate the Open Plan button (wait until visible in DOM)
let openPlanHandle = await page.waitForSelector("button.modal-select-budget-open", {
  visible: true,
  timeout: 20000,
});

// 2Ô∏è‚É£ Ensure it's really visible on screen
console.log("üéØ Ensuring Open Plan button is on screen...");
let box = await openPlanHandle.boundingBox();

// Sometimes null if offscreen ‚Üí scroll until it appears
let scrollAttempts = 0;
while (!box && scrollAttempts < 10) {
  await page.evaluate(() => window.scrollBy(0, 200));
  await page.waitForTimeout(300);
  box = await openPlanHandle.boundingBox();
  scrollAttempts++;
}

if (!box) throw new Error("‚ùå Cannot locate Open Plan button on screen.");

// 3Ô∏è‚É£ Move mouse to button like a human
console.log("üñ± Moving mouse to Open Plan button...");
await page.mouse.move(
  box.x + box.width / 2,
  box.y + box.height / 2,
  { steps: 25 }
);

await page.waitForTimeout(800); // Let hover animation happen

// 4Ô∏è‚É£ Check if submenu is visible
console.log("‚è≥ Waiting for submenu to appear...");
await page.waitForSelector(".settings-menu-recent-budgets", {
  visible: true,
  timeout: 5000
});

console.log("üìÇ Submenu is open!");

// 5Ô∏è‚É£ Locate all recent plan entries
const planEntries = await page.$$(".settings-menu-recent-budgets .menu-item");
let foundPlan = false;

// 6Ô∏è‚É£ Move the mouse and click the matching plan
for (const entry of planEntries) {
  const name = await entry.evaluate(el => el.innerText.trim());
  console.log("   ‚û§ Found plan:", name);

  if (name.toLowerCase() === budgetName.toLowerCase()) {
    const entryBox = await entry.boundingBox();
    if (entryBox) {
      console.log(`üñ± Hovering & clicking plan "${name}"...`);

      await page.mouse.move(
        entryBox.x + entryBox.width / 2,
        entryBox.y + entryBox.height / 2,
        { steps: 20 }
      );

      await page.waitForTimeout(300);
      await entry.click();
      foundPlan = true;
      break;
    }
  }
}

if (!foundPlan) {
  throw new Error(`‚ùå Could not find target plan '${budgetName}' inside submenu.`);
}

// 7Ô∏è‚É£ Wait for navigation after selecting plan
await page.waitForNavigation({ waitUntil: "networkidle0" });
console.log("üìÅ Budget opened successfully!");

const groupExists = await page.evaluate((groupName) => {
    return Array.from(document.querySelectorAll(".budget-table-cell-name"))
      .some(el => el.innerText.trim() === groupName);
  }, groupName);


  const subExists = await page.evaluate((groupName, catName) => {
    const groups = Array.from(document.querySelectorAll(".is-master-category"));
    for (const group of groups) {
      const title = group.querySelector(".budget-table-cell-name")?.innerText.trim();
      if (title !== groupName) continue;

      const subRows = group.parentElement.querySelectorAll(".is-sub-category");
      return Array.from(subRows).some(r =>
        r.querySelector(".budget-table-cell-name")?.innerText.trim() === catName
      );
    }
    return false;
  }, groupName, catName);


  if (!groupExists) {
    log(`‚ûï Creating category group: ${groupName}`);

    await page.click("button[title='Add Category Group']");
    await delay(300);

    await page.keyboard.type(groupName);
    await page.keyboard.press("Enter");
    await delay(400);

    log(`‚úÖ Group created: ${groupName}`);
  } else {
    log(`‚úîÔ∏è Group exists: ${groupName}`);
  }


  if (!subExists) {
    log(`‚ûï Creating subcategory: ${catName}`);

    await page.evaluate((groupName) => {
      const groups = Array.from(document.querySelectorAll(".is-master-category"));
      for (const group of groups) {
        const title = group.querySelector(".budget-table-cell-name")?.innerText.trim();
        if (title === groupName) {
          const addBtn = group.querySelector("button[title='Add Category']");
          if (addBtn) addBtn.click();
        }
      }
    }, groupName);

    await delay(300);
    await page.keyboard.type(catName);
    await page.keyboard.press("Enter");
    await delay(400);

    log(`‚úÖ Subcategory created: ${catName}`);
  } else {
    log(`‚úîÔ∏è Subcategory exists: ${catName}`);
  }


  log(`üí∞ Setting budget for ${catName}: ${amount}`);

  try {
    // Scroll the row into view
    await page.evaluate((groupName, catName) => {
      function findRow() {
        const groups = Array.from(document.querySelectorAll(".is-master-category"));
        for (const group of groups) {
          const gTitle = group.querySelector(".budget-table-cell-name")?.innerText.trim();
          if (gTitle !== groupName) continue;

          const rows = group.parentElement.querySelectorAll(".budget-table-row.is-sub-category");
          for (const r of rows) {
            const name = r.querySelector(".budget-table-cell-name")?.innerText.trim();
            if (name === catName) return r;
          }
        }
        return null;
      }

      const row = findRow();
      if (row) row.scrollIntoView({ behavior: "smooth", block: "center" });
    }, groupName, catName);

    await delay(500);

    // Click on the "Budgeted" cell
    await page.evaluate((groupName, catName) => {
      function findBudgetCell() {
        const groups = Array.from(document.querySelectorAll(".is-master-category"));
        for (const group of groups) {
          const title = group.querySelector(".budget-table-cell-name")?.innerText.trim();
          if (title !== groupName) continue;

          const rows = group.parentElement.querySelectorAll(".budget-table-row.is-sub-category");
          for (const r of rows) {
            const n = r.querySelector(".budget-table-cell-name")?.innerText.trim();
            if (n === catName) {
              return r.querySelector(".budget-table-cell-budgeted");
            }
          }
        }
        return null;
      }

      const cell = findBudgetCell();
      if (cell) cell.click();
    }, groupName, catName);

    await delay(300);

    // Type the amount into the budget field
    await page.keyboard.type(amount.toString(), { delay: 20 });
    await page.keyboard.press("Enter");
    await delay(300);